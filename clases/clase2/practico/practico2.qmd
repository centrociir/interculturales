---
title: "Introducci칩n a R"
subtitle: "Documento de trabajo"
author: "Mat칤as Deneken"
date: today
format:
  html:
    toc-title: "Contenidos"
    theme: flatly
    toc: true
    toc-depth: 3
    number-sections: true
    include-in-header:
      text: |
        <style>
          body::before {
            content: url('logo_ciir.jpg');
            display: block;
            text-align: left;
            margin-bottom: 5px;
            transform: scale(0.5);
          }
          body::before img {
            max-width: 100px;
            height: auto;
          }
          #title-block-header {
            margin-top: 0;
          }
          .quarto-title {
            margin-top: 0;
          }
        </style>
execute:
  warning: false
  message: false
  cache: false
editor: visual
reference-location: margin
citation-location: margin
---

## Cargar librer칤as necesarias

```{r}
# tidyverse: manipular datos, filtrar, agrupar, resumir y visualizar
library(tidyverse)
# ggplot2: crear visualizaciones con sistema de capas
library(ggplot2)
```

## Descargar y cargar datos

```{r}
# Definimos la URL y el nombre del archivo
url <- "https://raw.githubusercontent.com/centrociir/interculturales/refs/heads/main/clases/clase1/bbdd/casen2022_sample.csv"
destfile <- "casen2022_sample.csv"

# Descargamos el archivo desde GitHub
download.file(url, destfile, mode = "wb")

# Cargamos el CSV descargado en un dataframe
casen <- read.csv(destfile, encoding = "UTF-8")
```

## Inspeccionar los primeros datos

```{r}
# Mostrar primeras filas del dataset para conocer la estructura
tibble::as_tibble(head(casen))
```

## Visualizaciones exploratorias

### Histograma de edad

El histograma permite visualizar la distribuci칩n de la variable num칠rica edad dentro del conjunto de datos. Esta es una de las formas m치s directas de explorar c칩mo se distribuyen los valores de una variable continua.

**Pasos del c칩digo:**

-   `casen |> ggplot(aes(edad))`: inicia el gr치fico utilizando la base de datos casen y mapea la variable edad al eje X.

-   `geom_histogram(color = "white")`: agrega una capa de histograma (barras), usando el color blanco para el borde de las barras.

```{r}
casen |> ggplot(aes(edad)) +
  geom_histogram(color = "white") 
```

### Densidad por pertenencia a pueblo ind칤gena

Este gr치fico muestra la**distribuci칩n de la edad**맛sando curvas de densidad, diferenciadas por el grupo de pertenencia ind칤gena. A diferencia del histograma, las curvas de densidad suavizan la forma de la distribuci칩n y permiten comparar grupos m치s claramente.

**Pasos del c칩digo:**

1.  `casen |> ggplot(aes(edad, colour = pueblos_indigenas))`: se define el gr치fico base, mapeando la variable`edad`마l eje X y asignando un color distinto seg칰n la variable`pueblos_indigenas`.

2.  `geom_density()`: a침ade la geometr칤a de densidad, que estima la distribuci칩n de la variable`edad`.

```{r}
casen |> ggplot(aes(edad, colour = pueblos_indigenas)) +
  geom_density()
```

### Densidad de ingresos seg칰n pueblo ind칤gena

Este gr치fico permite observar c칩mo se distribuye el**ingreso aut칩nomo (`yautcor`)**만n la poblaci칩n, distinguiendo entre personas ind칤genas y no ind칤genas. Se utiliza una curva de densidad para facilitar la comparaci칩n entre ambos grupos.

**Pasos del c칩digo:**

1.  `mutate(...)`: convierte la variable`pueblos_indigenas`만n un**factor con etiquetas legibles**:`"No Ind칤gena"`맟`"Ind칤gena"`.

2.  `filter(yautcor < 100000)`:**excluye valores extremos**맋e ingreso para evitar que distorsionen el gr치fico.

3.  `ggplot(...)`: inicia el gr치fico asignando la variable`yautcor`마l eje X, y diferenciando los grupos por`fill`맟`color`.

4.  `geom_density(alpha = 0.6)`: genera curvas de densidad con cierta transparencia (`alpha = 0.6`) para que se puedan ver las superposiciones.

5.  `labs(...)`: define t칤tulo y etiquetas de los ejes.

6.  `theme_classic()`: aplica un tema con fondo blanco y sin cuadr칤culas para una presentaci칩n m치s limpia.

```{r}
casen |> 
  mutate(pueblos_indigenas = factor(pueblos_indigenas, levels = c(0, 1), labels = c("No Ind칤gena", "Ind칤gena"))) |> 
  filter(yautcor < 100000) |>  # eliminar extremos
  ggplot(aes(x = yautcor, fill = pueblos_indigenas, color = pueblos_indigenas)) +
  geom_density(alpha = 0.6) +
  labs(
    title = "Distribuci칩n del ingreso aut칩nomo seg칰n pertenencia ind칤gena",
    x = "Ingreso aut칩nomo (yautcor)",
    y = "Densidad",
    fill = "Pertenencia",
    color = "Pertenencia"
  ) +
  theme_classic()
```

### Gr치fico de dispersi칩n edad e ingreso

Este gr치fico muestra la relaci칩n entre la edad de las personas y su ingreso aut칩nomo (`yautcor`), con una**distinci칩n por pertenencia ind칤gena**. Se utiliza un gr치fico de puntos para visualizar la dispersi칩n de los datos individuales.

**Pasos del c칩digo:**

1.  `filter(yautcor < 1000001)`:**filtra valores extremos**맋e ingreso para mantener solo observaciones dentro de un rango razonable.

2.  `ggplot(...)`: inicializa el gr치fico asignando`yautcor`마l eje X y`edad`마l eje Y.

3.  `colour = as.factor(pueblos_indigenas)`: transforma la variable`pueblos_indigenas`만n factor para colorear los puntos por grupo.

4.  `geom_point(alpha = 0.3)`: agrega puntos con transparencia (`alpha = 0.3`) para**evitar saturaci칩n visual**만n zonas densas.

5.  `labs(...)`: agrega un t칤tulo claro y etiquetas a los ejes.

6.  `theme_minimal()`: aplica un dise침o limpio con fondo blanco y sin bordes.

```{r}
casen |> 
  filter(yautcor < 1000001) |>  # eliminar valores extremos
  ggplot(aes(x = yautcor, y = edad, colour = as.factor(pueblos_indigenas))) +
  geom_point(alpha = 0.3) +
  labs(
    title = "Ingreso aut칩nomo por edad (sin extremos)",
    x = "Edad",
    y = "Ingreso aut칩nomo (yautcor)",
    colour = "Pueblos ind칤genas"
  ) +
  theme_minimal()
```

### L칤nea de tendencia sin puntos

Este gr치fico representa la**tendencia general entre el ingreso aut칩nomo y la edad**, sin mostrar los puntos individuales. Es 칰til para detectar patrones globales cuando hay muchos datos.

**Pasos del c칩digo:**

1.  `filter(yautcor < 2000000)`: elimina outliers con ingresos extremadamente altos para evitar que afecten la tendencia.

2.  `ggplot(...)`: define el mapeo est칠tico con`yautcor`만n el eje X y`edad`만n el eje Y.

3.  `geom_smooth()`: agrega una**l칤nea suavizada**맘ue estima la relaci칩n entre ambas variables, utilizando por defecto un modelo de regresi칩n local (*loess*).

4.  `labs(...)`: define el t칤tulo del gr치fico y los nombres de los ejes.

5.  `theme_minimal()`: aplica un tema visual limpio.

```{r}
casen |> 
  filter(yautcor < 2000000) |>  # evitar outliers extremos
  ggplot(aes(x = yautcor, y = edad)) +
  geom_smooth() +
  labs(
    title = "Edad seg칰n ingreso aut칩nomo (sin extremos)",
    x = "Ingreso aut칩nomo (yautcor)",
    y = "Edad"
  ) +
  theme_minimal()
```

## Gr치fico de barras

### Conteo de personas por condici칩n ind칤gena

Este gr치fico muestra**cu치ntas personas en la muestra se identifican o no con un pueblo ind칤gena**. Es 칰til para visualizar la distribuci칩n de esta variable categ칩rica.

**Pasos del c칩digo:**

1.  `ggplot(aes(x = factor(pueblos_indigenas)))`: se transforma la variable`pueblos_indigenas`만n un**factor**, para que`ggplot2`맓a trate como una categor칤a en el eje X.

2.  `geom_bar()`: genera un gr치fico de barras contando autom치ticamente las observaciones por categor칤a.

3.  `labs(...)`: define el t칤tulo del gr치fico y los nombres de los ejes.

4.  `scale_x_discrete(...)`: reemplaza las etiquetas "0" y "1" por**"No Ind칤gena"**만**"Ind칤gena"**.

5.  `theme_minimal()`: aplica un tema limpio y moderno al gr치fico.

```{r}
casen |> 
  ggplot(aes(x = factor(pueblos_indigenas))) +
  geom_bar() +
  labs(
    title = "Distribuci칩n seg칰n pertenencia a pueblo ind칤gena",
    x = "Pertenencia",
    y = "Cantidad"
  ) +
  scale_x_discrete(labels = c("0" = "No Ind칤gena", "1" = "Ind칤gena")) +
  theme_minimal()
```

### Crear variable categ칩rica de nivel educativo

```{r}
casen <- casen |> 
  mutate(
    educ_nivel = case_when(
      educ %in% 0:1 ~ "Sin educaci칩n",
      educ %in% 2:4 ~ "B치sica",
      educ %in% 5:6 ~ "Media",
      educ %in% 7:8 ~ "T칠cnico nivel superior",
      educ %in% 9:11 ~ "Profesional",
      educ == 12 ~ "Postgrado",
      TRUE ~ NA_character_
    )
  )
```

### Agrupar y contar por nivel educativo y condici칩n

```{r}
tabla_educ <- casen |> 
  group_by(pueblos_indigenas, educ_nivel) |> 
  count()
```

### Gr치fico de barras agrupadas

Este gr치fico de barras compara**la cantidad de personas por nivel educativo**, diferenciando entre quienes**se identifican como ind칤genas y quienes no**. Al usar`position = "dodge"`, las barras se colocan una al lado de la otra, permitiendo comparar los grupos dentro de cada nivel educativo.

**Explicaci칩n paso a paso:**

1.  `ggplot(tabla_educ, aes(...))`: se define la base del gr치fico con la tabla`tabla_educ`, especificando:

    -   `x = educ_nivel`: eje X representa los niveles educativos.

    -   `y = n`: eje Y representa la cantidad de personas.

    -   `fill = factor(pueblos_indigenas)`: las barras se rellenan seg칰n la pertenencia ind칤gena.

2.  `geom_col(position = "dodge")`: crea un gr치fico de columnas usando los valores exactos (no conteos autom치ticos), y separa las barras por grupo.

3.  `labs(...)`: agrega t칤tulo y etiquetas a los ejes y leyenda.

4.  `scale_fill_manual(...)`: personaliza los colores de cada grupo:

    -   Gris para "No Ind칤gena"

    -   Naranja para "Ind칤gena"\
        Tambi칠n se cambian las etiquetas para que sean legibles.

5.  `theme_minimal()`: aplica un tema claro y limpio.

6.  `theme(...)`: rota las etiquetas del eje X 45 grados para mejorar su legibilidad

```{r}
ggplot(tabla_educ, aes(x = educ_nivel, y = n, fill = factor(pueblos_indigenas))) +
  geom_col(position = "dodge") +
  labs(
    title = "Distribuci칩n por nivel educativo y pertenencia ind칤gena",
    x = "Nivel educativo",
    y = "Cantidad de personas",
    fill = "Pueblos Ind칤genas"
  ) +
  scale_fill_manual(values = c("0" = "#999999", "1" = "#D95F02"), labels = c("No Ind칤gena", "Ind칤gena")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Calcular proporciones dentro de cada grupo

```{r}
tabla_educ_por_grupo <- tabla_educ |> 
  group_by(pueblos_indigenas) |> 
  mutate(prop = n / sum(n)) |> 
  ungroup()
```

### Gr치fico de barras por grupo con facetas

```{r}
ggplot(tabla_educ_por_grupo, aes(x = educ_nivel, y = prop, fill = educ_nivel)) +
  geom_col() +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), vjust = -0.5, size = 3) +
  facet_grid(~ pueblos_indigenas, labeller = as_labeller(c("0" = "No Ind칤gena", "1" = "Ind칤gena"))) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Distribuci칩n del nivel educativo dentro de cada grupo",
    x = "Nivel educativo",
    y = "Proporci칩n",
    fill = "Nivel educativo"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Gr치fico de tendencia con GSS

Este bloque de c칩digo**procesa la base de datos`gss_cat`**맋el paquete`forcats`, con el fin de calcular la**proporci칩n de personas que se identifican como "Strong Democrat"**만n EE.UU., desagregado por raza y a침o.

```{r}
library(forcats)

gss_party_race <- gss_cat |> 
  filter(!is.na(partyid), !is.na(race)) |>     # 1. Elimina valores perdidos en partido y raza
  group_by(year, race, partyid) |>             # 2. Agrupa por a침o, raza y afiliaci칩n partidaria
  summarise(n = n(), .groups = "drop") |>      # 3. Cuenta el n칰mero de casos por combinaci칩n
  group_by(year, race) |>                      # 4. Reagrupa por a침o y raza
  mutate(prop = n / sum(n)) |>                 # 5. Calcula la proporci칩n que representa cada partido
  ungroup()                                    # 6. Elimina agrupaciones


voto_duro <- gss_party_race |> filter(partyid == "Strong democrat")
```

### Gr치fico de tendencia final

```{r}
ggplot(voto_duro, aes(x = year, y = prop, color = race)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))
```

### Gr치fico bonito (ChatGPT 游땹)

```{r}
 g2 <-ggplot(voto_duro, aes(x = year, y = prop, color = race)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_color_brewer(palette = "Dark2") +
  labs(
    title = "Voto duro dem칩crata en EE.UU.",
    subtitle = "Proporci칩n que se identifica como 'Strong Democrat', por raza y a침o",
    caption = "Fuente: GSS (General Social Survey)",
    x = "A침o",
    y = "Proporci칩n",
    color = "Raza"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(margin = margin(b = 10)),
    plot.caption = element_text(color = "gray40", size = 9),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ); g2
```

### Guardar gr치fico con dimensiones de PowerPoint

```{r}
 ggsave("images/voto_duro_race_ppt.png", plot = last_plot(), width = 29.21, height = 12.09, units = "cm", dpi = 300)
 
```
